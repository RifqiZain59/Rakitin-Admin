{% extends "base.html" %}

{% block header_title %}Manajemen Inventaris Toko{% endblock %}

{% block content %}
<div id="modalTambah" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-sm transition-opacity" onclick="closeModal()"></div>

    <div class="relative min-h-screen flex items-center justify-center p-4">
        <div class="relative bg-white w-full max-w-md rounded-2xl shadow-xl border border-slate-100 overflow-hidden transform transition-all animate-fade-in-up">
            <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                    <i class="fas fa-plus-circle text-orange-500"></i> Tambah Barang Baru
                </h3>
                <button onclick="closeModal()" class="p-2 text-slate-400 hover:text-rose-500 hover:bg-rose-50 rounded-lg transition-all">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="formInventaris" class="p-6 space-y-4">
                <div>
                    <label class="block text-xs font-bold text-slate-600 mb-1 uppercase tracking-wider">Nama Barang</label>
                    <input type="text" id="nama_barang" required placeholder="Contoh: Semen Gresik" 
                        class="w-full px-4 py-2.5 bg-white border border-slate-200 rounded-xl text-sm text-slate-700 placeholder-slate-400 focus:outline-none focus:border-orange-500 focus:ring-4 focus:ring-orange-500/10 transition-all shadow-sm">
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-600 mb-1 uppercase tracking-wider">SKU / Kode</label>
                        <input type="text" id="sku" required placeholder="BRG-001" 
                            class="w-full px-4 py-2.5 bg-white border border-slate-200 rounded-xl text-sm text-slate-700 placeholder-slate-400 focus:outline-none focus:border-orange-500 focus:ring-4 focus:ring-orange-500/10 transition-all shadow-sm">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-600 mb-1 uppercase tracking-wider">Kategori</label>
                        <div class="relative">
                            <select id="kategori" class="w-full pl-4 pr-10 py-2.5 appearance-none cursor-pointer bg-white border border-slate-200 rounded-xl text-sm text-slate-700 focus:outline-none focus:border-orange-500 focus:ring-4 focus:ring-orange-500/10 transition-all shadow-sm">
                                <option value="Material Dasar">Material Dasar</option>
                                <option value="Finishing">Finishing</option>
                                <option value="Alat Kerja">Alat Kerja</option>
                            </select>
                            <i class="fas fa-chevron-down absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none text-xs"></i>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-600 mb-1 uppercase tracking-wider">Jumlah Stok</label>
                        <input type="number" id="stok" required placeholder="0" 
                            class="w-full px-4 py-2.5 bg-white border border-slate-200 rounded-xl text-sm text-slate-700 placeholder-slate-400 focus:outline-none focus:border-orange-500 focus:ring-4 focus:ring-orange-500/10 transition-all shadow-sm">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-600 mb-1 uppercase tracking-wider">Satuan</label>
                        <input type="text" id="satuan" required placeholder="Sak / Pcs" 
                            class="w-full px-4 py-2.5 bg-white border border-slate-200 rounded-xl text-sm text-slate-700 placeholder-slate-400 focus:outline-none focus:border-orange-500 focus:ring-4 focus:ring-orange-500/10 transition-all shadow-sm">
                    </div>
                </div>

                <div class="pt-4 flex gap-3">
                    <button type="button" onclick="closeModal()" 
                        class="flex-1 px-4 py-2.5 border border-slate-200 text-slate-600 rounded-xl font-bold hover:bg-slate-50 hover:text-slate-800 transition-all text-sm">
                        Batal
                    </button>
                    <button type="submit" id="btnSimpan"
                        class="flex-1 px-4 py-2.5 bg-gradient-to-r from-orange-600 to-orange-500 text-white rounded-xl font-bold hover:from-orange-700 hover:to-orange-600 transition-all shadow-md shadow-orange-200 text-sm flex justify-center items-center gap-2">
                        <span>Simpan Barang</span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
    <div class="p-6 border-b border-slate-100 flex flex-col md:flex-row justify-between items-center gap-4 bg-slate-50/30">
        <div class="relative w-full md:w-96 group flex items-center">
            <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 group-focus-within:text-orange-500 transition-colors"></i>
            <input type="text" id="searchInput" placeholder="Cari nama barang atau SKU..." class="w-full pl-12 pr-4 py-2.5 bg-white rounded-xl border border-slate-200 text-sm focus:outline-none focus:border-orange-500 focus:ring-4 focus:ring-orange-500/10 transition-all shadow-sm">
        </div>
        
        <button onclick="openModal()" class="w-full md:w-auto bg-gradient-to-r from-orange-600 to-orange-500 hover:from-orange-700 hover:to-orange-600 text-white px-5 py-2.5 rounded-xl font-bold transition-all flex items-center justify-center gap-2 text-sm">
            <i class="fas fa-plus"></i> Tambah Barang
        </button>
    </div>

    <div class="overflow-x-auto">
        <table class="w-full text-left whitespace-nowrap">
            <thead class="bg-slate-50 text-slate-500 text-xs uppercase font-bold tracking-wider">
                <tr>
                    <th class="px-6 py-4 border-b border-slate-100">SKU</th>
                    <th class="px-6 py-4 border-b border-slate-100">Nama Barang</th>
                    <th class="px-6 py-4 border-b border-slate-100">Kategori</th>
                    <th class="px-6 py-4 border-b border-slate-100">Stok</th>
                    <th class="px-6 py-4 border-b border-slate-100">Satuan</th>
                    <th class="px-6 py-4 border-b border-slate-100 text-center">Aksi</th>
                </tr>
            </thead>
            <tbody id="tabelBody" class="divide-y divide-slate-100 text-sm text-slate-700">
                <tr>
                    <td colspan="6" class="text-center py-8 text-slate-400">
                        <i class="fas fa-spinner fa-spin mr-2"></i> Memuat data...
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<script type="module">
    // 1. Import Firebase SDK
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, deleteDoc, doc } 
    from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    // 2. KONFIGURASI FIREBASE (GANTI DENGAN DATA DARI FIREBASE CONSOLE ANDA)
    const firebaseConfig = {
        apiKey: "API_KEY_ANDA_DISINI",
        authDomain: "PROJECT_ID.firebaseapp.com",
        projectId: "PROJECT_ID",
        storageBucket: "PROJECT_ID.appspot.com",
        messagingSenderId: "SENDER_ID",
        appId: "APP_ID"
    };

    // 3. Inisialisasi Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const inventarisCollection = collection(db, "inventaris"); // Nama koleksi di database

    // --- FUNGSI MODAL UI ---
    window.openModal = function() {
        document.getElementById('modalTambah').classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    }

    window.closeModal = function() {
        document.getElementById('modalTambah').classList.add('hidden');
        document.body.style.overflow = 'auto';
        document.getElementById('formInventaris').reset(); // Reset form saat ditutup
    }

    // --- FUNGSI 1: KIRIM DATA KE FIREBASE (CREATE) ---
    document.getElementById('formInventaris').addEventListener('submit', async (e) => {
        e.preventDefault(); // Mencegah reload halaman
        
        const btnSimpan = document.getElementById('btnSimpan');
        const originalText = btnSimpan.innerHTML;
        // PERBAIKAN 3: Ikon spinner saat loading simpan
        btnSimpan.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Menyimpan...';
        btnSimpan.disabled = true;

        try {
            // Ambil value dari input
            const newItem = {
                nama_barang: document.getElementById('nama_barang').value,
                sku: document.getElementById('sku').value,
                kategori: document.getElementById('kategori').value,
                stok: parseInt(document.getElementById('stok').value),
                satuan: document.getElementById('satuan').value,
                createdAt: new Date() // Untuk sorting
            };

            // Kirim ke Firestore
            await addDoc(inventarisCollection, newItem);
            
            // Tutup modal
            closeModal();

        } catch (error) {
            console.error("Error adding document: ", error);
            alert("Gagal menyimpan: " + error.message);
        } finally {
            btnSimpan.innerHTML = originalText;
            btnSimpan.disabled = false;
        }
    });

    // --- FUNGSI 2: AMBIL DATA DARI FIREBASE (READ REALTIME) ---
    // onSnapshot akan berjalan setiap kali ada perubahan di database
    const q = query(inventarisCollection, orderBy("createdAt", "desc"));
    
    onSnapshot(q, (snapshot) => {
        const tabelBody = document.getElementById('tabelBody');
        tabelBody.innerHTML = ''; // Bersihkan tabel sebelum render ulang

        if (snapshot.empty) {
            tabelBody.innerHTML = `<tr><td colspan="6" class="text-center py-6 text-slate-400">Belum ada data barang.</td></tr>`;
            return;
        }

        snapshot.forEach((docSnap) => {
            const data = docSnap.data();
            const id = docSnap.id; // ID unik dokumen firebase

            // Buat baris tabel HTML
            const row = `
                <tr class="hover:bg-slate-50/80 transition-colors group">
                    <td class="px-6 py-4 font-mono text-xs text-slate-400 font-medium">${data.sku}</td>
                    <td class="px-6 py-4 font-bold text-slate-800">${data.nama_barang}</td>
                    <td class="px-6 py-4">
                        <span class="inline-flex items-center gap-1.5 bg-slate-100 text-slate-700 border border-slate-200 px-2.5 py-1 rounded-lg text-xs font-bold">
                            <i class="fas fa-tag text-[10px]"></i> ${data.kategori}
                        </span>
                    </td>
                    <td class="px-6 py-4 font-bold ${data.stok < 10 ? 'text-rose-600' : 'text-emerald-600'}">${data.stok}</td>
                    <td class="px-6 py-4 text-slate-500">${data.satuan}</td>
                    <td class="px-6 py-4 flex justify-center gap-2">
                        <button onclick="hapusBarang('${id}')" class="w-8 h-8 flex items-center justify-center text-rose-600 bg-rose-50 hover:bg-rose-600 hover:text-white rounded-lg transition-colors shadow-sm" title="Hapus">
                            <i class="fas fa-trash text-sm"></i>
                        </button>
                    </td>
                </tr>
            `;
            tabelBody.insertAdjacentHTML('beforeend', row);
        });
    });

    // --- FUNGSI 3: HAPUS DATA (DELETE) ---
    window.hapusBarang = async function(id) {
        if(confirm('Yakin ingin menghapus barang ini?')) {
            try {
                await deleteDoc(doc(db, "inventaris", id));
            } catch (error) {
                console.error("Gagal menghapus", error);
                alert("Gagal menghapus data");
            }
        }
    }
</script>
{% endblock %}