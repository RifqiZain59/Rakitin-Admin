{% extends "base.html" %}
{% block header_title %}Manajemen Inventaris & Alat Tukang{% endblock %}

{% block content %}

<div id="toastNotif" class="fixed top-5 right-5 z-[100] transform transition-all duration-300 translate-x-full opacity-0 flex items-center bg-white border-l-4 rounded-xl shadow-xl px-5 py-4 min-w-[280px]">
    <i id="toastIcon" class="fas mr-3 text-xl"></i>
    <div id="toastText" class="text-sm font-bold text-slate-700"></div>
</div>

<div id="modalTambah" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-sm transition-opacity" onclick="closeModal()"></div>

    <div class="relative min-h-screen flex items-center justify-center p-4">
        <div class="relative bg-white w-full max-w-md rounded-2xl shadow-xl border border-slate-100 overflow-hidden transform transition-all animate-fade-in-up">
            <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                    <i class="fas fa-toolbox text-orange-500"></i> Tambah Alat Baru
                </h3>
                <button type="button" onclick="closeModal()" class="p-2 text-slate-400 hover:text-rose-500 hover:bg-rose-50 rounded-lg transition-all">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form action="{{ url_for('tambah_alat') }}" method="POST" id="formTambah" class="p-6 space-y-4" 
                  onsubmit="handleFormSubmit('btnSimpan', 'Menyimpan...', 'Data alat berhasil ditambahkan!')">
                
                <div>
                    <label class="block text-xs font-bold text-slate-600 mb-1 uppercase tracking-wider">Nama Alat</label>
                    <input type="text" name="nama_alat" required placeholder="Contoh: Bor Listrik 13mm" 
                        class="w-full px-4 py-2.5 bg-white border border-slate-200 rounded-xl text-sm text-slate-700 focus:outline-none focus:border-orange-500 focus:ring-4 focus:ring-orange-500/10 transition-all shadow-sm">
                </div>

                <div>
                    <label class="block text-xs font-bold text-slate-600 mb-1 uppercase tracking-wider">Merk (Opsional)</label>
                    <input type="text" name="merk" placeholder="Contoh: Bosch / Tekiro" 
                        class="w-full px-4 py-2.5 bg-white border border-slate-200 rounded-xl text-sm text-slate-700 focus:outline-none focus:border-orange-500 focus:ring-4 focus:ring-orange-500/10 transition-all shadow-sm">
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-600 mb-1 uppercase tracking-wider">Kategori</label>
                        <div class="relative">
                            <select name="kategori" class="w-full pl-4 pr-10 py-2.5 appearance-none cursor-pointer bg-white border border-slate-200 rounded-xl text-sm text-slate-700 focus:outline-none focus:border-orange-500 focus:ring-4 focus:ring-orange-500/10 transition-all shadow-sm">
                                <option value="Perkakas Tangan">Perkakas Tangan</option>
                                <option value="Perkakas Listrik">Perkakas Listrik</option>
                                <option value="Alat Ukur">Alat Ukur</option>
                                <option value="Alat Keselamatan">Alat Keselamatan</option>
                                <option value="Alat Berat">Alat Berat</option>
                            </select>
                            <i class="fas fa-chevron-down absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none text-xs"></i>
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-600 mb-1 uppercase tracking-wider">Kondisi</label>
                        <div class="relative">
                            <select name="kondisi" class="w-full pl-4 pr-10 py-2.5 appearance-none cursor-pointer bg-white border border-slate-200 rounded-xl text-sm text-slate-700 focus:outline-none focus:border-orange-500 focus:ring-4 focus:ring-orange-500/10 transition-all shadow-sm">
                                <option value="Baik">Baik</option>
                                <option value="Perlu Servis">Perlu Servis</option>
                                <option value="Rusak">Rusak</option>
                            </select>
                            <i class="fas fa-chevron-down absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none text-xs"></i>
                        </div>
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-bold text-slate-600 mb-1 uppercase tracking-wider">Jumlah / Ketersediaan (Unit)</label>
                    <input type="number" name="ketersediaan" min="0" required placeholder="0" 
                        class="w-full px-4 py-2.5 bg-white border border-slate-200 rounded-xl text-sm text-slate-700 focus:outline-none focus:border-orange-500 focus:ring-4 focus:ring-orange-500/10 transition-all shadow-sm">
                </div>

                <div class="pt-4 flex gap-3">
                    <button type="button" onclick="closeModal()" 
                        class="flex-1 px-4 py-2.5 border border-slate-200 text-slate-600 rounded-xl font-bold hover:bg-slate-50 hover:text-slate-800 transition-all text-sm">
                        Batal
                    </button>
                    <button type="submit" id="btnSimpan"
                        class="flex-1 px-4 py-2.5 bg-gradient-to-r from-orange-600 to-orange-500 text-white rounded-xl font-bold hover:from-orange-700 hover:to-orange-600 transition-all shadow-md shadow-orange-200 text-sm flex justify-center items-center gap-2">
                        <i class="fas fa-save"></i> <span>Simpan Alat</span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<div id="modalEdit" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-sm transition-opacity" onclick="closeEditModal()"></div>

    <div class="relative min-h-screen flex items-center justify-center p-4">
        <div class="relative bg-white w-full max-w-md rounded-2xl shadow-xl border border-slate-100 overflow-hidden transform transition-all animate-fade-in-up">
            <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-blue-50/50">
                <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                    <i class="fas fa-edit text-blue-500"></i> Edit Data Alat
                </h3>
                <button type="button" onclick="closeEditModal()" class="p-2 text-slate-400 hover:text-rose-500 hover:bg-rose-50 rounded-lg transition-all">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form action="{{ url_for('edit_alat') }}" method="POST" id="formEditAlat" class="p-6 space-y-4"
                  onsubmit="handleFormSubmit('btnUpdate', 'Memperbarui...', 'Data alat berhasil diperbarui!')">
                
                <input type="hidden" name="id" id="edit_id">

                <div>
                    <label class="block text-xs font-bold text-slate-600 mb-1 uppercase tracking-wider">Nama Alat</label>
                    <input type="text" name="nama_alat" id="edit_nama_alat" required 
                        class="w-full px-4 py-2.5 bg-white border border-slate-200 rounded-xl text-sm text-slate-700 focus:outline-none focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10 transition-all shadow-sm">
                </div>

                <div>
                    <label class="block text-xs font-bold text-slate-600 mb-1 uppercase tracking-wider">Merk (Opsional)</label>
                    <input type="text" name="merk" id="edit_merk" placeholder="Contoh: Bosch / Tekiro" 
                        class="w-full px-4 py-2.5 bg-white border border-slate-200 rounded-xl text-sm text-slate-700 focus:outline-none focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10 transition-all shadow-sm">
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-600 mb-1 uppercase tracking-wider">Kategori</label>
                        <div class="relative">
                            <select name="kategori" id="edit_kategori" class="w-full pl-4 pr-10 py-2.5 appearance-none cursor-pointer bg-white border border-slate-200 rounded-xl text-sm text-slate-700 focus:outline-none focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10 transition-all shadow-sm">
                                <option value="Perkakas Tangan">Perkakas Tangan</option>
                                <option value="Perkakas Listrik">Perkakas Listrik</option>
                                <option value="Alat Ukur">Alat Ukur</option>
                                <option value="Alat Keselamatan">Alat Keselamatan</option>
                                <option value="Alat Berat">Alat Berat</option>
                            </select>
                            <i class="fas fa-chevron-down absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none text-xs"></i>
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-600 mb-1 uppercase tracking-wider">Kondisi</label>
                        <div class="relative">
                            <select name="kondisi" id="edit_kondisi" class="w-full pl-4 pr-10 py-2.5 appearance-none cursor-pointer bg-white border border-slate-200 rounded-xl text-sm text-slate-700 focus:outline-none focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10 transition-all shadow-sm">
                                <option value="Baik">Baik</option>
                                <option value="Perlu Servis">Perlu Servis</option>
                                <option value="Rusak">Rusak</option>
                            </select>
                            <i class="fas fa-chevron-down absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none text-xs"></i>
                        </div>
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-bold text-slate-600 mb-1 uppercase tracking-wider">Jumlah / Ketersediaan (Unit)</label>
                    <input type="number" name="ketersediaan" id="edit_ketersediaan" min="0" required 
                        class="w-full px-4 py-2.5 bg-white border border-slate-200 rounded-xl text-sm text-slate-700 focus:outline-none focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10 transition-all shadow-sm">
                </div>

                <div class="pt-4 flex gap-3">
                    <button type="button" onclick="closeEditModal()" 
                        class="flex-1 px-4 py-2.5 border border-slate-200 text-slate-600 rounded-xl font-bold hover:bg-slate-50 hover:text-slate-800 transition-all text-sm">
                        Batal
                    </button>
                    <button type="submit" id="btnUpdate"
                        class="flex-1 px-4 py-2.5 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700 transition-all shadow-md shadow-blue-200 text-sm flex justify-center items-center gap-2">
                        <i class="fas fa-save"></i> <span>Perbarui Data</span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
    <div class="p-6 border-b border-slate-100 flex flex-col md:flex-row justify-between items-center gap-4 bg-slate-50/30">
        <div class="relative w-full md:w-96 group">
            <i class="fas fa-search absolute left-4 top-3.5 text-slate-400 group-focus-within:text-orange-500 transition-colors"></i>
            <input type="text" placeholder="Cari nama alat, merk, atau kode..." class="w-full pl-11 pr-4 py-2.5 bg-white rounded-xl border border-slate-200 text-sm focus:outline-none focus:border-orange-500 focus:ring-4 focus:ring-orange-500/10 transition-all shadow-sm">
        </div>
        <button onclick="openModal()" class="w-full md:w-auto bg-gradient-to-r from-orange-600 to-orange-500 hover:from-orange-700 hover:to-orange-600 text-white px-5 py-2.5 rounded-xl font-bold shadow-sm transition-all flex items-center justify-center gap-2 text-sm">
            <i class="fas fa-plus"></i> Tambah Alat
        </button>
    </div>

    <div class="overflow-x-auto">
        <table class="w-full text-left whitespace-nowrap">
            <thead class="bg-slate-50 text-slate-500 text-xs uppercase font-bold tracking-wider">
                <tr>
                    <th class="px-6 py-4 border-b border-slate-100">Kode Alat</th>
                    <th class="px-6 py-4 border-b border-slate-100">Nama Alat & Merk</th>
                    <th class="px-6 py-4 border-b border-slate-100">Kategori</th>
                    <th class="px-6 py-4 border-b border-slate-100">Ketersediaan</th>
                    <th class="px-6 py-4 border-b border-slate-100">Kondisi</th>
                    <th class="px-6 py-4 border-b border-slate-100 text-center">Aksi</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-slate-100 text-sm text-slate-700">
                {% if daftar_alat %}
                    {% for alat in daftar_alat %}
                    <tr class="hover:bg-slate-50/80 transition-colors group">
                        <td class="px-6 py-4 font-mono text-xs text-slate-400 font-medium">{{ alat.kode | default('ALT-000') }}</td>
                        <td class="px-6 py-4">
                            <p class="font-bold text-slate-800">{{ alat.nama_alat }}</p>
                            <p class="text-xs text-slate-500">Merk: {{ alat.merk | default('-') }}</p>
                        </td>
                        <td class="px-6 py-4">
                            {% if alat.kategori == 'Perkakas Listrik' %}
                                <span class="inline-flex items-center gap-1.5 bg-orange-50 text-orange-700 border border-orange-100 px-2.5 py-1 rounded-lg text-xs font-bold">
                                    <i class="fas fa-plug text-[10px]"></i> {{ alat.kategori }}
                                </span>
                            {% elif alat.kategori == 'Alat Ukur' %}
                                <span class="inline-flex items-center gap-1.5 bg-teal-50 text-teal-700 border border-teal-100 px-2.5 py-1 rounded-lg text-xs font-bold">
                                    <i class="fas fa-ruler text-[10px]"></i> {{ alat.kategori }}
                                </span>
                            {% else %}
                                <span class="inline-flex items-center gap-1.5 bg-blue-50 text-blue-700 border border-blue-100 px-2.5 py-1 rounded-lg text-xs font-bold">
                                    <i class="fas fa-hammer text-[10px]"></i> {{ alat.kategori }}
                                </span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 font-bold {% if (alat.ketersediaan|int) > 5 %}text-emerald-600{% elif (alat.ketersediaan|int) > 0 %}text-amber-500{% else %}text-rose-500{% endif %}">
                            {{ alat.ketersediaan }} Unit
                        </td>
                        <td class="px-6 py-4">
                            {% if alat.kondisi == 'Baik' %}
                                <span class="text-emerald-600 font-medium text-xs flex items-center gap-1"><i class="fas fa-check-circle"></i> Baik</span>
                            {% elif alat.kondisi == 'Perlu Servis' %}
                                <span class="text-amber-600 font-medium text-xs flex items-center gap-1"><i class="fas fa-wrench"></i> Perlu Servis</span>
                            {% else %}
                                <span class="text-rose-600 font-medium text-xs flex items-center gap-1"><i class="fas fa-times-circle"></i> Rusak</span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 flex justify-center gap-2">
                            <button onclick="openEditModal('{{ alat.id }}', '{{ alat.nama_alat }}', '{{ alat.merk }}', '{{ alat.kategori }}', '{{ alat.kondisi }}', '{{ alat.ketersediaan }}')" class="w-8 h-8 flex items-center justify-center text-blue-600 bg-blue-50 hover:bg-blue-600 hover:text-white rounded-lg transition-colors shadow-sm" title="Edit">
                                <i class="fas fa-edit text-sm"></i>
                            </button>
                            <button class="w-8 h-8 flex items-center justify-center text-red-600 bg-red-50 hover:bg-red-600 hover:text-white rounded-lg transition-colors shadow-sm" title="Hapus">
                                <i class="fas fa-trash text-sm"></i>
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                {% else %}
                    <tr><td colspan="6" class="text-center py-8 text-slate-400 italic">Belum ada data alat yang disimpan.</td></tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>

<script>
    // --- SCRIPT UNTUK MODAL & NOTIFIKASI TOAST ---
    document.addEventListener("DOMContentLoaded", function() {
        let notifMsg = sessionStorage.getItem('notif_msg');
        if (notifMsg) {
            showToast(notifMsg);
            sessionStorage.removeItem('notif_msg');
        }
    });

    function showToast(message) {
        const toast = document.getElementById('toastNotif');
        const icon = document.getElementById('toastIcon');
        const text = document.getElementById('toastText');

        text.innerText = message;
        toast.classList.add('border-emerald-500');
        icon.className = 'fas fa-check-circle text-emerald-500 mr-3 text-xl';

        setTimeout(() => { toast.classList.remove('translate-x-full', 'opacity-0'); }, 100);
        setTimeout(() => { toast.classList.add('translate-x-full', 'opacity-0'); }, 3000);
    }

    function handleFormSubmit(btnId, loadingText, successMsg) {
        sessionStorage.setItem('notif_msg', successMsg);
        let btn = document.getElementById(btnId);
        
        setTimeout(() => {
            btn.disabled = true;
            btn.innerHTML = `<i class='fas fa-spinner fa-spin mr-2'></i> ${loadingText}`;
        }, 10);
    }

    // FUNGSI MODAL TAMBAH
    function openModal() {
        document.getElementById('modalTambah').classList.remove('hidden');
        document.body.style.overflow = 'hidden';
        
        let btn = document.getElementById('btnSimpan');
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-save"></i> <span>Simpan Alat</span>';
    }

    function closeModal() {
        document.getElementById('modalTambah').classList.add('hidden');
        document.body.style.overflow = 'auto';
        document.getElementById('formTambah').reset();
    }

    // FUNGSI MODAL EDIT
    function openEditModal(id, nama, merk, kategori, kondisi, ketersediaan) {
        // Mengisi form Edit dengan data dari baris tabel yang diklik
        document.getElementById('edit_id').value = id;
        document.getElementById('edit_nama_alat').value = nama;
        document.getElementById('edit_merk').value = merk;
        document.getElementById('edit_kategori').value = kategori;
        document.getElementById('edit_kondisi').value = kondisi;
        document.getElementById('edit_ketersediaan').value = ketersediaan;

        // Reset state tombol
        let btn = document.getElementById('btnUpdate');
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-save"></i> <span>Perbarui Data</span>';

        // Tampilkan Modal
        document.getElementById('modalEdit').classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    }

    function closeEditModal() {
        document.getElementById('modalEdit').classList.add('hidden');
        document.body.style.overflow = 'auto';
        document.getElementById('formEditAlat').reset();
    }
</script>
{% endblock %}